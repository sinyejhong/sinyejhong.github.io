---
import news from "../data/news.json";

// Config: 3 items per page for a "Grid" feel
const itemsPerPage = 3;
const totalPages = Math.ceil(news.length / itemsPerPage);

// Helper: Highlight Text
function highlightText(
    text: string,
    highlights?: string[],
    links?: Record<string, string | undefined>,
    emphasis?: string[],
): string {
    let result = text;

    // Links
    if (links) {
        Object.entries(links).forEach(([linkText, url]) => {
            if (!url) return;
            result = result.replace(
                new RegExp(
                    linkText.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                    "g",
                ),
                `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-accent hover:underline z-20 relative">${linkText}</a>`,
            );
        });
    }

    // Emphasis
    if (emphasis?.length) {
        emphasis.forEach((e) => {
            result = result.replace(
                new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "g"),
                `<span class="font-bold text-navy">${e}</span>`,
            );
        });
    }

    // Highlights
    if (highlights?.length) {
        highlights.forEach((h) => {
            result = result.replace(
                new RegExp(h.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "g"),
                `<span class="text-accent font-semibold bg-accent/5 px-1 rounded">${h}</span>`,
            );
        });
    }

    return result;
}

// Helper: Pillar Config
const pillarConfig: Record<
    string,
    {
        label: string;
        text: string;
        href: string;
        spacingClass?: string;
        spacing: string;
    }
> = {
    perception: {
        label: "Resilient Perception",
        text: "text-blue-700",
        href: "/research#perception",
        spacingClass: "space-y-1",
        spacing: "pr-1 pb-1 -mt-2",
    },
    inspection: {
        label: "Industrial AIoT",
        text: "text-emerald-700",
        href: "/research#inspection",
        spacingClass: "space-y-1",
        spacing: "pr-1 pb-0 -mt-3",
    },
    robotics: {
        label: "Embodied AI",
        text: "text-purple-700",
        href: "/research#robotics",
        spacingClass: "space-y-1",
        spacing: "pr-1 pb-1 -mt-2",
    },
    academic: {
        label: "Academic",
        text: "text-orange-700",
        href: "#",
        spacingClass: "space-y-1",
        spacing: "pr-1 pb-1 -mt-2",
    },
};

// Helper: Date Formatting
function getMoonthAndDay(dateStr: string) {
    const date = new Date(dateStr);
    return {
        month: date
            .toLocaleDateString("en-US", { month: "short" })
            .toUpperCase(),
        day: date.getDate(),
        year: date.getFullYear(),
    };
}
---

<section class="section-padding bg-gray-50/50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Section Header -->
        <!-- Section Header -->
        <div class="flex flex-col md:flex-row items-center md:items-end justify-between mb-10 gap-4">
            <!-- Left Spacer for centering balance -->
            <div class="hidden md:block flex-1"></div>

            <!-- Center Title -->
            <div class="text-center flex-none">
                <h2
                    class="text-3xl md:text-4xl font-heading font-bold text-navy mb-3"
                >
                    Latest News
                </h2>
                <div class="w-20 h-1 bg-accent rounded-full mb-4 mx-auto"></div>
                <p class="text-gray-text text-lg max-w-2xl">
                    Recent breakthroughs, publications, and lab announcements
                </p>
            </div>

            <!-- Right Controls -->
            <div class="flex items-center gap-3 w-full md:w-auto md:flex-1 justify-center md:justify-end mt-4 md:mt-0">
                <button
                    id="news-prev"
                    class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-navy hover:bg-accent hover:text-white hover:border-accent transition-all disabled:opacity-30 disabled:hover:bg-white disabled:hover:text-navy"
                    aria-label="Previous page"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <button
                    id="news-next"
                    class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-navy hover:bg-accent hover:text-white hover:border-accent transition-all disabled:opacity-30 disabled:hover:bg-white disabled:hover:text-navy"
                    aria-label="Next page"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- News Grid Carousel -->
        <div class="relative min-h-[400px]" id="news-container">
            {
                Array.from({ length: totalPages }).map((_, pageIndex) => (
                    <div
                        class:list={[
                            "news-page grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 transition-opacity duration-500 absolute inset-0 w-full items-stretch",
                            pageIndex === 0
                                ? "opacity-100 relative z-10"
                                : "opacity-0 absolute z-0 pointer-events-none",
                        ]}
                        data-page={pageIndex}
                    >
                        {news
                            .slice(
                                pageIndex * itemsPerPage,
                                (pageIndex + 1) * itemsPerPage,
                            )
                            .map((item, i) => {
                                const { month, day, year } = getMoonthAndDay(
                                    item.date,
                                );
                                const hasImage =
                                    item.images && item.images.length > 0;
                                const coverImage = hasImage
                                    ? item.images[0]
                                    : null;

                                return (
                                    <article class="group relative bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden flex flex-col h-full hover:-translate-y-1 read-more-btn cursor-pointer">
                                        {/* Cover Image or Color Block */}
                                        <div class="h-48 overflow-hidden relative bg-navy/5">
                                            {coverImage ? (
                                                <img
                                                    src={coverImage}
                                                    alt="News cover"
                                                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                                                />
                                            ) : (
                                                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-200">
                                                    <svg
                                                        class="w-12 h-12 text-gray-300"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="1.5"
                                                            d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
                                                        />
                                                    </svg>
                                                </div>
                                            )}

                                            {/* Date Block (Absolute) */}
                                            <div class="absolute top-4 left-4 bg-white/95 backdrop-blur shadow-md rounded-xl p-2 text-center min-w-[3.5rem] border border-gray-100">
                                                <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                                    {month}
                                                </div>
                                                <div class="text-xl font-bold text-navy leading-none mt-0.5">
                                                    {day}
                                                </div>
                                            </div>


                                        </div>

                                        {/* Content */}
                                        <div class="p-6 flex flex-col flex-grow relative z-10">
                                            {/* Watermark Pillar Graphic */}
                                            {item.pillar &&
                                                pillarConfig[item.pillar] && (
                                                    <a
                                                        href={
                                                            pillarConfig[
                                                                item.pillar
                                                            ].href
                                                        }
                                                        class:list={[
                                                            "absolute bottom-0 right-0 flex flex-col items-end opacity-50 group-hover:opacity-100 transition-all duration-500 pointer-events-auto z-30",
                                                            pillarConfig[
                                                                item.pillar
                                                            ].text,
                                                            pillarConfig[
                                                                item.pillar
                                                            ].spacingClass,
                                                        ]}
                                                        onclick="event.stopPropagation()"
                                                        title={`Go to ${pillarConfig[item.pillar].label}`}
                                                    >
                                                        <div class="w-20 h-20 transform rotate-12 transition-transform duration-500 group-hover:rotate-0 group-hover:scale-110">
                                                            {item.pillar ===
                                                                "perception" && (
                                                                <svg
                                                                    class="w-full h-full"
                                                                    fill="none"
                                                                    stroke="currentColor"
                                                                    viewBox="0 0 24 24"
                                                                >
                                                                    <path
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"
                                                                    />
                                                                </svg>
                                                            )}
                                                            {item.pillar ===
                                                                "inspection" && (
                                                                <svg
                                                                    class="w-full h-full"
                                                                    fill="none"
                                                                    stroke="currentColor"
                                                                    viewBox="0 0 24 24"
                                                                >
                                                                    <path
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                                                    />
                                                                    <path
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                                                    />
                                                                </svg>
                                                            )}
                                                            {item.pillar ===
                                                                "robotics" && (
                                                                <svg
                                                                    class="w-full h-full"
                                                                    fill="none"
                                                                    stroke="currentColor"
                                                                    viewBox="0 0 24 24"
                                                                >
                                                                    <path
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                                                                    />
                                                                </svg>
                                                            )}
                                                            {item.pillar ===
                                                                "academic" && (
                                                                <svg
                                                                    class="w-full h-full"
                                                                    fill="none"
                                                                    stroke="currentColor"
                                                                    viewBox="0 0 24 24"
                                                                >
                                                                    <path
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M12 14l9-5-9-5-9 5 9 5z"
                                                                    />
                                                                    <path
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"
                                                                    />
                                                                </svg>
                                                            )}
                                                        </div>
                                                        <span
                                                            class:list={[
                                                                "text-[0.6rem] font-bold tracking-widest uppercase text-right opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform translate-y-2 group-hover:translate-y-0",
                                                                pillarConfig[
                                                                    item.pillar
                                                                ].spacing,
                                                            ]}
                                                        >
                                                            {
                                                                pillarConfig[
                                                                    item.pillar
                                                                ].label
                                                            }
                                                        </span>
                                                    </a>
                                                )}
                                            <div class="text-xs text-gray-400 mb-3 font-medium flex items-center gap-2">
                                                <span>{year}</span>
                                                {/* New badge if recent (logic: within current year or first 2 items) */}
                                                {pageIndex === 0 && i < 2 && (
                                                    <span class="px-2 py-0.5 bg-accent/10 text-accent rounded-full font-bold animate-pulse">
                                                        NEW
                                                    </span>
                                                )}
                                            </div>

                                            <div
                                                class="text-gray-700 leading-relaxed text-sm mb-4 line-clamp-4 min-h-[5rem] text-justify"
                                                set:html={highlightText(
                                                    item.text,
                                                    item.highlights,
                                                    item.links,
                                                    item.emphasis,
                                                )}
                                            />
                                            
                                            <!-- Hidden Full Content for Modal -->
                                            <div class="hidden news-full-content">
                                                <div class="news-raw-text" set:html={highlightText(
                                                    item.text,
                                                    item.highlights,
                                                    item.links,
                                                    item.emphasis,
                                                )}></div>
                                                <div class="news-meta-date" data-month={month} data-day={day} data-year={year}></div>
                                                <div class="news-meta-pillar" data-pillar={item.pillar} data-label={item.pillar && pillarConfig[item.pillar] ? pillarConfig[item.pillar].label : ''}></div>
                                                <div class="news-images">
                                                    {item.images && item.images.map(img => (
                                                        <img src={img} class="hidden-news-img" />
                                                    ))}
                                                </div>
                                            </div>




                                        </div>
                                    </article>
                                );
                            })}
                    </div>
                ))
            }
        </div>

        <!-- Mobile Controls (Pagination Dots) -->
        <div class="flex justify-center mt-8 gap-2">
            {
                Array.from({ length: totalPages }).map((_, i) => (
                    <button
                        class="mobile-dot w-2 h-2 rounded-full bg-gray-300 transition-all data-[active=true]:bg-accent data-[active=true]:w-6"
                        data-index={i}
                        aria-label={`Go to page ${i + 1}`}
                    />
                ))
            }
        </div>
    </div>
</section>

<!-- Lightbox Modal -->
<div
    id="news-lightbox"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-navy/90 backdrop-blur-sm opacity-0 transition-opacity duration-300"
>
    <button
        id="lightbox-close"
        class="absolute top-4 right-4 text-white/70 hover:text-white transition-colors z-50 p-2"
    >
        <svg
            class="w-8 h-8"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </button>
    <img
        id="lightbox-image"
        src=""
        alt="Full size"
        class="max-w-[95vw] max-h-[90vh] object-contain rounded-lg shadow-2xl scale-95 transition-transform duration-300"
    />
</div>

<!-- News Detail Modal -->
<div
    id="news-detail-modal"
    class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-navy/90 backdrop-blur-sm opacity-0 transition-opacity duration-300 px-4"
>
    <div 
        class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl relative transform scale-95 transition-transform duration-300 flex flex-col"
        id="news-detail-content"
    >
         <!-- Close Button -->
        <button
            id="news-detail-close"
            class="absolute top-4 right-4 p-2 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-600 hover:text-navy transition-colors z-20"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <!-- Modal Content -->
        <div class="p-8">
            <div class="flex items-center gap-3 mb-6">
                 <span id="modal-date" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-lg text-sm font-semibold"></span>
                 <span id="modal-pillar" class="hidden px-3 py-1 rounded-lg text-sm font-bold uppercase tracking-wide"></span>
            </div>

            <div id="modal-text" class="prose prose-blue max-w-none text-lg leading-relaxed text-gray-700 mb-8">
            </div>

            <!-- Image Gallery in Modal -->
            <div id="modal-gallery" class="space-y-4">
            </div>
        </div>
    </div>
</div>

<script define:vars={{ totalPages }}>
    // Track current page globally for accurate click handling
    window.newsCarouselCurrentPage = 0;

    // Lightbox Global Function
    window.openLightbox = (src) => {
        const lightbox = document.getElementById("news-lightbox");
        const img = document.getElementById("lightbox-image");
        if (lightbox && img) {
            img.src = src;
            lightbox.classList.remove("hidden");
            // Small delay for fade in
            requestAnimationFrame(() => {
                lightbox.classList.remove("opacity-0");
                img.classList.remove("scale-95");
                img.classList.add("scale-100");
            });
        }
    };

    // News Detail Modal Logic
    const newsModal = document.getElementById("news-detail-modal");
    const newsModalContent = document.getElementById("news-detail-content");
    const newsModalClose = document.getElementById("news-detail-close");
    
    function openNewsModal(article) {
         if (!newsModal || !newsModalContent) return;
         
         // Extract data
         const fullContentDiv = article.querySelector('.news-full-content');
         if(!fullContentDiv) return;

         const rawText = fullContentDiv.querySelector('.news-raw-text').innerHTML;
         const dateDiv = fullContentDiv.querySelector('.news-meta-date');
         const pillarDiv = fullContentDiv.querySelector('.news-meta-pillar');
         const pillar = pillarDiv.dataset.pillar;
         const pillarLabel = pillarDiv.dataset.label;
         const images = fullContentDiv.querySelectorAll('.hidden-news-img');

         // Populate Modal
         document.getElementById('modal-text').innerHTML = rawText;
         
         // Date
         const dateStr = `${dateDiv.dataset.month} ${dateDiv.dataset.day}, ${dateDiv.dataset.year}`;
         document.getElementById('modal-date').textContent = dateStr;

         // Pillar
         const pillarSpan = document.getElementById('modal-pillar');
         // Simple mapping for colors (reusing what we know from pillarConfig logic roughly, or just general styles)
         // Since we don't have the full config object here easily without duplication, let's just make it look nice generic styling or add classes dynamically
         pillarSpan.className = "hidden px-3 py-1 rounded-lg text-sm font-bold uppercase tracking-wide"; // reset
         if (pillar) {
             pillarSpan.classList.remove('hidden');
             pillarSpan.textContent = pillarLabel || pillar;
             // Add some color based on pillar name
             if (pillar.includes('perception')) pillarSpan.classList.add('bg-blue-100', 'text-blue-700');
             else if (pillar.includes('inspection')) pillarSpan.classList.add('bg-emerald-100', 'text-emerald-700');
             else if (pillar.includes('robotics')) pillarSpan.classList.add('bg-purple-100', 'text-purple-700');
             else pillarSpan.classList.add('bg-orange-100', 'text-orange-700');
         } else {
             pillarSpan.classList.add('hidden');
         }

         // Images
         const gallery = document.getElementById('modal-gallery');
         gallery.innerHTML = '';
         images.forEach(img => {
             const newImg = document.createElement('img');
             newImg.src = img.src;
             newImg.className = "w-full rounded-xl shadow-md border border-gray-100";
             gallery.appendChild(newImg);
         });

         // Show Modal
         newsModal.classList.remove("hidden");
         document.body.style.overflow = 'hidden'; // Prevent background scroll
         requestAnimationFrame(() => {
             newsModal.classList.remove("opacity-0");
             newsModalContent.classList.remove("scale-95");
             newsModalContent.classList.add("scale-100");
         });
    }

    function closeNewsModal() {
        if (!newsModal) return;
        newsModal.classList.add("opacity-0");
        if (newsModalContent) {
            newsModalContent.classList.remove("scale-100");
            newsModalContent.classList.add("scale-95");
        }
        setTimeout(() => {
            newsModal.classList.add("hidden");
            document.body.style.overflow = ''; // Restore scroll
        }, 300);
    }

    newsModalClose?.addEventListener('click', closeNewsModal);
    
    // Wire up Read More buttons
    document.addEventListener("click", (e) => {
        const btn = e.target.closest(".read-more-btn");
        if (btn) {
            const article = btn.closest("article");
            if (article) openNewsModal(article);
        }
    });

    // Close on outside click
     newsModal?.addEventListener("click", (e) => {
        if (e.target === newsModal) closeNewsModal();
    });

    // Close on Esc
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
             closeNewsModal();
             // Also close lightbox if open (existing logic covers this but good to be safe)
        }
    });

    // Event delegation for lightbox triggers
    document.addEventListener("click", (e) => {
        const trigger = e.target.closest(".lightbox-trigger");
        if (!trigger) return;

        // Check if the trigger's page is the active one
        const parentPage = trigger.closest(".news-page");
        if (!parentPage) return;

        // Use the global current page variable for accurate comparison
        const pageIndex = parseInt(parentPage.dataset.page, 10);
        if (pageIndex === window.newsCarouselCurrentPage) {
            const imageSrc = trigger.dataset.image;
            if (imageSrc) {
                window.openLightbox(imageSrc);
            }
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        let currentPage = 0;
        const total = totalPages;

        const pages = document.querySelectorAll(".news-page");
        const prevBtn = document.getElementById("news-prev");
        const nextBtn = document.getElementById("news-next");
        const mobileDots = document.querySelectorAll(".mobile-dot");

        function updateView(newIndex) {
            // Validate index
            if (newIndex < 0 || newIndex >= total) return;

            currentPage = newIndex;
            // Sync global variable for lightbox click handling
            window.newsCarouselCurrentPage = currentPage;

            // Update Pages
            pages.forEach((page, i) => {
                const isCurrent = i === currentPage;
                // We use opacity for transition, z-index for interaction
                if (isCurrent) {
                    page.classList.remove(
                        "opacity-0",
                        "absolute",
                        "z-0",
                        "pointer-events-none",
                    );
                    page.classList.add("opacity-100", "relative", "z-10");
                } else {
                    page.classList.remove("opacity-100", "relative", "z-10");
                    page.classList.add(
                        "opacity-0",
                        "absolute",
                        "z-0",
                        "pointer-events-none",
                    );
                }
            });

            // Update Desktop Buttons
            if (prevBtn) prevBtn.disabled = currentPage === 0;
            if (nextBtn) nextBtn.disabled = currentPage === total - 1;

            // Update Mobile Dots
            mobileDots.forEach((dot, i) => {
                if (i === currentPage) {
                    dot.setAttribute("data-active", "true");
                } else {
                    dot.setAttribute("data-active", "false");
                }
            });
        }

        // Event Listeners
        prevBtn?.addEventListener("click", () => updateView(currentPage - 1));
        nextBtn?.addEventListener("click", () => updateView(currentPage + 1));

        mobileDots.forEach((dot) => {
            dot.addEventListener("click", (e) => {
                const index = parseInt(e.target.dataset.index);
                updateView(index);
            });
        });

        // ===== Auto-Cycling Logic (First 2 Pages Only) =====
        const AUTO_CYCLE_INTERVAL = 10000; // 10 seconds (slower for better UX)
        const AUTO_CYCLE_MAX_PAGE = 1; // Cycle between page 0 and 1
        let autoPlayTimer = null;
        let isPaused = false;
        let interactionTimeout = null; // Timer to resume after user interaction

        function startAutoCycle() {
            if (autoPlayTimer) clearInterval(autoPlayTimer);
            autoPlayTimer = setInterval(() => {
                // Check if lightbox or news modal is open
                const lightbox = document.getElementById("news-lightbox");
                const newsModal = document.getElementById("news-detail-modal");
                
                const isLightboxOpen = lightbox && !lightbox.classList.contains("hidden");
                const isNewsModalOpen = newsModal && !newsModal.classList.contains("hidden");

                if (isPaused || isLightboxOpen || isNewsModalOpen) return;

                // Cycle only between pages 0 and 1
                const nextPage =
                    currentPage >= AUTO_CYCLE_MAX_PAGE ? 0 : currentPage + 1;
                updateView(nextPage);
            }, AUTO_CYCLE_INTERVAL);
        }

        function pauseAutoCycle() {
            isPaused = true;
        }

        function resumeAutoCycle() {
            // Only resume if not in a user-interaction pause state (handled by handleUserInteraction)
            if (!interactionTimeout) {
                isPaused = false;
            }
        }

        // Pause for a longer specified duration after explicit user interaction
        function handleUserInteraction() {
            isPaused = true;
            if (interactionTimeout) clearTimeout(interactionTimeout);
            
            // Resume regular checking after 15 seconds of inactivity
            interactionTimeout = setTimeout(() => {
                isPaused = false;
                interactionTimeout = null;
            }, 15000);
        }

        // Pause on hover over the news container
        const newsContainer = document.getElementById("news-container");
        newsContainer?.addEventListener("mouseenter", pauseAutoCycle);
        newsContainer?.addEventListener("mouseleave", resumeAutoCycle);

        // Hook up user interaction events to the pause logic
        prevBtn?.addEventListener("click", handleUserInteraction);
        nextBtn?.addEventListener("click", handleUserInteraction);
        mobileDots.forEach(dot => dot.addEventListener("click", handleUserInteraction));

        // Start auto-cycling on page load
        startAutoCycle();
        // ===== End Auto-Cycling Logic =====

        // Lightbox Close Logic
        const lightbox = document.getElementById("news-lightbox");
        const lightboxClose = document.getElementById("lightbox-close");

        const closeLightbox = () => {
            if (!lightbox) return;
            lightbox.classList.add("opacity-0");
            const img = document.getElementById("lightbox-image");
            if (img) {
                img.classList.remove("scale-100");
                img.classList.add("scale-95");
            }
            setTimeout(() => {
                lightbox.classList.add("hidden");
            }, 300);
        };

        lightboxClose?.addEventListener("click", closeLightbox);
        lightbox?.addEventListener("click", (e) => {
            if (e.target === lightbox) closeLightbox();
        });
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeLightbox();
        });

        // Initialize state
        updateView(0);
    });
</script>
